/*
 * Copyright 2020 Hippo B.V. (http://www.onehippo.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { ChangeDetectorRef, ChangeDetectionStrategy, Component, ContentChild, Inject, Input, NgZone, Output, Optional, PLATFORM_ID, TemplateRef, ViewChild, } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { isPlatformBrowser, isPlatformServer } from '@angular/common';
import { makeStateKey, TransferState } from '@angular/platform-browser';
import { from, of, BehaviorSubject, Subject } from 'rxjs';
import { filter, map, mapTo, pairwise, pluck, switchMap, take } from 'rxjs/operators';
import { destroy, initialize, isPage } from '@bloomreach/spa-sdk';
/**
 * The brXM page.
 */
export class BrPageComponent {
    constructor(changeDetectorRef, httpClient, zone, platform, transferState) {
        this.changeDetectorRef = changeDetectorRef;
        this.httpClient = httpClient;
        this.platform = platform;
        this.transferState = transferState;
        /**
         * The brXM and Angular components mapping.
         */
        this.mapping = {};
        /**
         * The TransferState key is used to transfer the state from the server-side to the client-side.
         * By default, it equals to `brPage`.
         * If `false` is passed then the state transferring feature will be disabled.
         */
        this.stateKey = makeStateKey('brPage');
        /**
         * The current state of the page component.
         */
        this.state = new BehaviorSubject(undefined);
        this.afterContentChecked$ = new Subject();
        this.request = this.request.bind(this);
        this.state.pipe(pairwise(), pluck(0), filter(isPage))
            .subscribe(destroy);
        this.state.pipe(filter(isPage), switchMap((page) => this.afterContentChecked$.pipe(take(1), mapTo(page))))
            .subscribe((page) => zone.runOutsideAngular(() => page.sync()));
        this.state.pipe(filter(() => isPlatformServer(this.platform)), filter(isPage))
            .subscribe((page) => { var _a; return this.stateKey && ((_a = this.transferState) === null || _a === void 0 ? void 0 : _a.set(this.stateKey, page.toJSON())); });
    }
    get context() {
        const page = this.state.getValue();
        const component = page === null || page === void 0 ? void 0 : page.getComponent();
        if (!page || !component) {
            return;
        }
        return {
            component,
            page,
            $implicit: component,
            template: this.template,
        };
    }
    ngOnChanges(changes) {
        var _a, _b, _c, _d, _e, _f;
        if (changes.configuration || changes.page) {
            this.initialize((_a = changes.page) === null || _a === void 0 ? void 0 : _a.currentValue);
        }
        if (((_b = changes.stateKey) === null || _b === void 0 ? void 0 : _b.previousValue) && isPlatformServer(this.platform)) {
            if (changes.stateKey.currentValue && ((_c = this.transferState) === null || _c === void 0 ? void 0 : _c.hasKey(changes.stateKey.previousValue))) {
                (_d = this.transferState) === null || _d === void 0 ? void 0 : _d.set(changes.stateKey.currentValue, (_e = this.transferState) === null || _e === void 0 ? void 0 : _e.get(changes.stateKey.previousValue, undefined));
            }
            (_f = this.transferState) === null || _f === void 0 ? void 0 : _f.remove(changes.stateKey.previousValue);
        }
    }
    ngAfterContentChecked() {
        this.afterContentChecked$.next();
    }
    ngOnDestroy() {
        this.state.next(undefined);
        this.state.complete();
        this.afterContentChecked$.complete();
    }
    initialize(page) {
        var _a, _b, _c;
        if (this.stateKey && isPlatformBrowser(this.platform) && ((_a = this.transferState) === null || _a === void 0 ? void 0 : _a.hasKey(this.stateKey))) {
            page = page !== null && page !== void 0 ? page : (_b = this.transferState) === null || _b === void 0 ? void 0 : _b.get(this.stateKey, undefined);
            (_c = this.transferState) === null || _c === void 0 ? void 0 : _c.remove(this.stateKey);
        }
        const configuration = Object.assign({ httpClient: this.request }, this.configuration);
        const observable = page
            ? of(initialize(configuration, page))
            : from(initialize(configuration));
        observable.subscribe(state => {
            this.state.next(state);
            this.changeDetectorRef.detectChanges();
        });
    }
    request(...[{ data: body, headers, method, url }]) {
        return this.httpClient.request(method, url, {
            body,
            headers: headers,
            responseType: 'json'
        })
            .pipe(map(data => ({ data })))
            .toPromise();
    }
}
BrPageComponent.decorators = [
    { type: Component, args: [{
                changeDetection: ChangeDetectionStrategy.OnPush,
                selector: 'br-page',
                template: "<!--\n  Copyright 2020 Hippo B.V. (http://www.onehippo.com)\n\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n  -->\n\n<ng-template #brNode let-component let-template=\"template\">\n  <ng-container [brNode]=\"component\" [brNodeTemplate]=\"template\">\n    <ng-container [ngSwitch]=\"component | brNodeType\">\n      <ng-container *ngSwitchCase=\"'container-item'\" [brNodeContainerItem]=\"component\"></ng-container>\n      <ng-container *ngSwitchCase=\"'container'\" [brNodeContainer]=\"component\"></ng-container>\n      <ng-container *ngSwitchDefault [brNodeComponent]=\"component\"></ng-container>\n    </ng-container>\n  </ng-container>\n</ng-template>\n\n<ng-template *ngIf=\"context\" [ngTemplateOutlet]=\"brNode\" [ngTemplateOutletContext]=\"context\"></ng-template>\n"
            },] }
];
BrPageComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: HttpClient },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: TransferState, decorators: [{ type: Optional }] }
];
BrPageComponent.propDecorators = {
    configuration: [{ type: Input }],
    mapping: [{ type: Input }],
    page: [{ type: Input }],
    stateKey: [{ type: Input }],
    state: [{ type: Output }],
    node: [{ type: ViewChild, args: ['brNode', { static: true },] }],
    template: [{ type: ContentChild, args: [TemplateRef, { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnItcGFnZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vc3JjLyIsInNvdXJjZXMiOlsibGliL2JyLXBhZ2UvYnItcGFnZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFFSCxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLHVCQUF1QixFQUN2QixTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBQ0wsTUFBTSxFQUdOLE1BQU0sRUFDTixRQUFRLEVBQ1IsV0FBVyxFQUVYLFdBQVcsRUFFWCxTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxZQUFZLEVBQVksYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEYsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFrQyxNQUFNLHFCQUFxQixDQUFDO0FBUWxHOztHQUVHO0FBTUgsTUFBTSxPQUFPLGVBQWU7SUFvQzFCLFlBQ1UsaUJBQW9DLEVBQ3BDLFVBQXNCLEVBQzlCLElBQVksRUFDaUIsUUFBYSxFQUN0QixhQUE2QjtRQUp6QyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGVBQVUsR0FBVixVQUFVLENBQVk7UUFFRCxhQUFRLEdBQVIsUUFBUSxDQUFLO1FBQ3RCLGtC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QUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBMEM7UUFDaEcsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FDNUIsTUFBTSxFQUNOLEdBQUcsRUFDSDtZQUNFLElBQUk7WUFDSixPQUFPLEVBQUUsT0FBNEM7WUFDckQsWUFBWSxFQUFFLE1BQU07U0FDckIsQ0FDRjthQUNBLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzNCLFNBQVMsRUFBRSxDQUFDO0lBQ2YsQ0FBQzs7O1lBOUlGLFNBQVMsU0FBQztnQkFDVCxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtnQkFDL0MsUUFBUSxFQUFFLFNBQVM7Z0JBQ25CLGd4Q0FBdUM7YUFDeEM7OztZQXJDQyxpQkFBaUI7WUFpQlYsVUFBVTtZQVhqQixNQUFNOzRDQXdFSCxNQUFNLFNBQUMsV0FBVztZQTNEVSxhQUFhLHVCQTREekMsUUFBUTs7OzRCQXBDVixLQUFLO3NCQUtMLEtBQUs7bUJBTUwsS0FBSzt1QkFPTCxLQUFLO29CQUtMLE1BQU07bUJBRU4sU0FBUyxTQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7dUJBRXBDLFlBQVksU0FBQyxXQUFXLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDIwIEhpcHBvIEIuVi4gKGh0dHA6Ly93d3cub25laGlwcG8uY29tKVxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50Q2hlY2tlZCxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZCxcbiAgSW5qZWN0LFxuICBJbnB1dCxcbiAgTmdab25lLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBPcHRpb25hbCxcbiAgUExBVEZPUk1fSUQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFRlbXBsYXRlUmVmLFxuICBUeXBlLFxuICBWaWV3Q2hpbGQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyLCBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IG1ha2VTdGF0ZUtleSwgU3RhdGVLZXksIFRyYW5zZmVyU3RhdGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IGZyb20sIG9mLCBCZWhhdmlvclN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtYXBUbywgcGFpcndpc2UsIHBsdWNrLCBzd2l0Y2hNYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBkZXN0cm95LCBpbml0aWFsaXplLCBpc1BhZ2UsIENvbmZpZ3VyYXRpb24sIFBhZ2UsIFBhZ2VNb2RlbCB9IGZyb20gJ0BibG9vbXJlYWNoL3NwYS1zZGsnO1xuaW1wb3J0IHsgQnJDb21wb25lbnRDb250ZXh0IH0gZnJvbSAnLi4vYnItY29tcG9uZW50LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBCclByb3BzIH0gZnJvbSAnLi4vYnItcHJvcHMubW9kZWwnO1xuXG5pbnRlcmZhY2UgQnJOb2RlQ29udGV4dCBleHRlbmRzIEJyQ29tcG9uZW50Q29udGV4dCB7XG4gIHRlbXBsYXRlPzogVGVtcGxhdGVSZWY8QnJDb21wb25lbnRDb250ZXh0Pjtcbn1cblxuLyoqXG4gKiBUaGUgYnJYTSBwYWdlLlxuICovXG5AQ29tcG9uZW50KHtcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIHNlbGVjdG9yOiAnYnItcGFnZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9ici1wYWdlLmNvbXBvbmVudC5odG1sJyxcbn0pXG5leHBvcnQgY2xhc3MgQnJQYWdlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50Q2hlY2tlZCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICAvKipcbiAgICogVGhlIGNvbmZpZ3VyYXRpb24gb2YgdGhlIFNQQSBTREsuXG4gICAqIEBzZWUgaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvQGJsb29tcmVhY2gvc3BhLXNkayNjb25maWd1cmF0aW9uXG4gICAqL1xuICBASW5wdXQoKSBjb25maWd1cmF0aW9uITogT21pdDxDb25maWd1cmF0aW9uLCAnaHR0cENsaWVudCc+O1xuXG4gIC8qKlxuICAgKiBUaGUgYnJYTSBhbmQgQW5ndWxhciBjb21wb25lbnRzIG1hcHBpbmcuXG4gICAqL1xuICBASW5wdXQoKSBtYXBwaW5nOiBSZWNvcmQ8c3RyaW5nLCBUeXBlPEJyUHJvcHM+PiA9IHt9O1xuXG4gIC8qKlxuICAgKiBUaGUgcHJlLWluaXRpYWxpemVkIHBhZ2UgaW5zdGFuY2Ugb3IgcHJlZmV0Y2hlZCBwYWdlIG1vZGVsLlxuICAgKiBNb3N0bHkgdGhpcyBwcm9wZXJ0eSBzaG91bGQgYmUgdXNlZCB0byB0cmFuc2ZlciBzdGF0ZSBmcm9tIHRoZSBzZXJ2ZXItc2lkZSB0byB0aGUgY2xpZW50LXNpZGUuXG4gICAqL1xuICBASW5wdXQoKSBwYWdlPzogUGFnZSB8IFBhZ2VNb2RlbDtcblxuICAvKipcbiAgICogVGhlIFRyYW5zZmVyU3RhdGUga2V5IGlzIHVzZWQgdG8gdHJhbnNmZXIgdGhlIHN0YXRlIGZyb20gdGhlIHNlcnZlci1zaWRlIHRvIHRoZSBjbGllbnQtc2lkZS5cbiAgICogQnkgZGVmYXVsdCwgaXQgZXF1YWxzIHRvIGBiclBhZ2VgLlxuICAgKiBJZiBgZmFsc2VgIGlzIHBhc3NlZCB0aGVuIHRoZSBzdGF0ZSB0cmFuc2ZlcnJpbmcgZmVhdHVyZSB3aWxsIGJlIGRpc2FibGVkLlxuICAgKi9cbiAgQElucHV0KCkgc3RhdGVLZXk6IFN0YXRlS2V5PFBhZ2VNb2RlbCB8IHVuZGVmaW5lZD4gfCBmYWxzZSA9IG1ha2VTdGF0ZUtleSgnYnJQYWdlJyk7XG5cbiAgLyoqXG4gICAqIFRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBwYWdlIGNvbXBvbmVudC5cbiAgICovXG4gIEBPdXRwdXQoKSBzdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UGFnZSB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblxuICBAVmlld0NoaWxkKCdick5vZGUnLCB7IHN0YXRpYzogdHJ1ZSB9KSBub2RlITogVGVtcGxhdGVSZWY8QnJOb2RlQ29udGV4dD47XG5cbiAgQENvbnRlbnRDaGlsZChUZW1wbGF0ZVJlZiwgeyBzdGF0aWM6IHRydWUgfSkgcHJpdmF0ZSB0ZW1wbGF0ZT86IFRlbXBsYXRlUmVmPEJyQ29tcG9uZW50Q29udGV4dD47XG5cbiAgcHJpdmF0ZSBhZnRlckNvbnRlbnRDaGVja2VkJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgIHpvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtOiBhbnksXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSB0cmFuc2ZlclN0YXRlPzogVHJhbnNmZXJTdGF0ZSxcbiAgKSB7XG4gICAgdGhpcy5yZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0LmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLnN0YXRlLnBpcGUoXG4gICAgICBwYWlyd2lzZSgpLFxuICAgICAgcGx1Y2soMCksXG4gICAgICBmaWx0ZXIoaXNQYWdlKSxcbiAgICApXG4gICAgLnN1YnNjcmliZShkZXN0cm95KTtcblxuICAgIHRoaXMuc3RhdGUucGlwZShcbiAgICAgIGZpbHRlcihpc1BhZ2UpLFxuICAgICAgc3dpdGNoTWFwKChwYWdlKSA9PiB0aGlzLmFmdGVyQ29udGVudENoZWNrZWQkLnBpcGUodGFrZSgxKSwgbWFwVG8ocGFnZSkpKSxcbiAgICApXG4gICAgLnN1YnNjcmliZSgocGFnZSkgPT4gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBwYWdlLnN5bmMoKSkpO1xuXG4gICAgdGhpcy5zdGF0ZS5waXBlKFxuICAgICAgZmlsdGVyKCgpID0+IGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybSkpLFxuICAgICAgZmlsdGVyKGlzUGFnZSksXG4gICAgKVxuICAgIC5zdWJzY3JpYmUoKHBhZ2UpID0+IHRoaXMuc3RhdGVLZXkgJiYgdGhpcy50cmFuc2ZlclN0YXRlPy5zZXQodGhpcy5zdGF0ZUtleSwgcGFnZS50b0pTT04oKSkpO1xuICB9XG5cbiAgZ2V0IGNvbnRleHQoKTogQnJOb2RlQ29udGV4dCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgcGFnZSA9IHRoaXMuc3RhdGUuZ2V0VmFsdWUoKTtcbiAgICBjb25zdCBjb21wb25lbnQgPSBwYWdlPy5nZXRDb21wb25lbnQoKTtcblxuICAgIGlmICghcGFnZSB8fCAhY29tcG9uZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbXBvbmVudCxcbiAgICAgIHBhZ2UsXG4gICAgICAkaW1wbGljaXQ6IGNvbXBvbmVudCxcbiAgICAgIHRlbXBsYXRlOiB0aGlzLnRlbXBsYXRlLFxuICAgIH07XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuY29uZmlndXJhdGlvbiB8fCBjaGFuZ2VzLnBhZ2UpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZShjaGFuZ2VzLnBhZ2U/LmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMuc3RhdGVLZXk/LnByZXZpb3VzVmFsdWUgJiYgaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtKSkge1xuICAgICAgaWYgKGNoYW5nZXMuc3RhdGVLZXkuY3VycmVudFZhbHVlICYmIHRoaXMudHJhbnNmZXJTdGF0ZT8uaGFzS2V5KGNoYW5nZXMuc3RhdGVLZXkucHJldmlvdXNWYWx1ZSkpIHtcbiAgICAgICAgdGhpcy50cmFuc2ZlclN0YXRlPy5zZXQoXG4gICAgICAgICAgY2hhbmdlcy5zdGF0ZUtleS5jdXJyZW50VmFsdWUsXG4gICAgICAgICAgdGhpcy50cmFuc2ZlclN0YXRlPy5nZXQoY2hhbmdlcy5zdGF0ZUtleS5wcmV2aW91c1ZhbHVlLCB1bmRlZmluZWQpLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnRyYW5zZmVyU3RhdGU/LnJlbW92ZShjaGFuZ2VzLnN0YXRlS2V5LnByZXZpb3VzVmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50Q2hlY2tlZCgpOiB2b2lkIHtcbiAgICB0aGlzLmFmdGVyQ29udGVudENoZWNrZWQkLm5leHQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3RhdGUubmV4dCh1bmRlZmluZWQpO1xuICAgIHRoaXMuc3RhdGUuY29tcGxldGUoKTtcbiAgICB0aGlzLmFmdGVyQ29udGVudENoZWNrZWQkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemUocGFnZTogUGFnZSB8IFBhZ2VNb2RlbCB8IHVuZGVmaW5lZCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN0YXRlS2V5ICYmIGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pICYmIHRoaXMudHJhbnNmZXJTdGF0ZT8uaGFzS2V5KHRoaXMuc3RhdGVLZXkpKSB7XG4gICAgICBwYWdlID0gcGFnZSA/PyB0aGlzLnRyYW5zZmVyU3RhdGU/LmdldCh0aGlzLnN0YXRlS2V5LCB1bmRlZmluZWQpO1xuICAgICAgdGhpcy50cmFuc2ZlclN0YXRlPy5yZW1vdmUodGhpcy5zdGF0ZUtleSk7XG4gICAgfVxuXG4gICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHsgaHR0cENsaWVudDogdGhpcy5yZXF1ZXN0LCAuLi50aGlzLmNvbmZpZ3VyYXRpb24gfSBhcyBDb25maWd1cmF0aW9uO1xuICAgIGNvbnN0IG9ic2VydmFibGUgPSBwYWdlXG4gICAgICA/IG9mKGluaXRpYWxpemUoY29uZmlndXJhdGlvbiwgcGFnZSkpXG4gICAgICA6IGZyb20oaW5pdGlhbGl6ZShjb25maWd1cmF0aW9uKSk7XG5cbiAgICBvYnNlcnZhYmxlLnN1YnNjcmliZShzdGF0ZSA9PiB7XG4gICAgICB0aGlzLnN0YXRlLm5leHQoc3RhdGUpO1xuICAgICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlcXVlc3QoLi4uW3sgZGF0YTogYm9keSwgaGVhZGVycywgbWV0aG9kLCB1cmwgfV06IFBhcmFtZXRlcnM8Q29uZmlndXJhdGlvblsnaHR0cENsaWVudCddPikge1xuICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucmVxdWVzdDxQYWdlTW9kZWw+KFxuICAgICAgbWV0aG9kLFxuICAgICAgdXJsLFxuICAgICAge1xuICAgICAgICBib2R5LFxuICAgICAgICBoZWFkZXJzOiBoZWFkZXJzIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHN0cmluZ1tdPixcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAnanNvbidcbiAgICAgIH0sXG4gICAgKVxuICAgIC5waXBlKG1hcChkYXRhID0+ICh7ZGF0YX0pKSlcbiAgICAudG9Qcm9taXNlKCk7XG4gIH1cbn1cbiJdfQ==