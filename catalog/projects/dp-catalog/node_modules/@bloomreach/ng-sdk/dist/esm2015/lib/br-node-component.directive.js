/*
 * Copyright 2020 Hippo B.V. (http://www.onehippo.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { ComponentFactoryResolver, Directive, Injector, ViewContainerRef, } from '@angular/core';
import { BrNodeDirective } from './br-node.directive';
import { BrPageComponent } from './br-page/br-page.component';
export class BrNodeComponentDirective {
    constructor(container, injector, componentFactoryResolver, node, page) {
        this.container = container;
        this.injector = injector;
        this.componentFactoryResolver = componentFactoryResolver;
        this.node = node;
        this.page = page;
    }
    ngOnChanges(changes) {
        var _a;
        (_a = this.clear) === null || _a === void 0 ? void 0 : _a.call(this);
        this.container.clear();
        const { head, tail } = this.render();
        this.clear = head && tail && this.component.getMeta().render(head, tail);
    }
    getMapping() {
        return this.page.mapping[this.component.getName()];
    }
    render() {
        if (this.node.template) {
            return this.renderTemplate();
        }
        const component = this.getMapping();
        if (!component) {
            return this.renderChildren();
        }
        return this.renderMapping(component);
    }
    renderTemplate() {
        // tslint:disable: no-non-null-assertion
        const embeddedViewRef = this.container.createEmbeddedView(this.node.template, {
            $implicit: this.component,
            component: this.component,
            page: this.page.state.getValue(),
        });
        // tslint:enable: no-non-null-assertion
        const [head] = embeddedViewRef.rootNodes;
        const [tail] = embeddedViewRef.rootNodes.slice(-1);
        return { head, tail };
    }
    renderChildren() {
        var _a, _b;
        const nodes = this.component.getChildren()
            .map(component => this.container.createEmbeddedView(this.page.node, {
            component,
            $implicit: component,
            page: this.page.state.getValue(),
        }))
            .flatMap(view => view.rootNodes);
        const head = (_a = nodes[0]) !== null && _a !== void 0 ? _a : this.container.element.nativeElement;
        const tail = (_b = nodes[nodes.length - 1]) !== null && _b !== void 0 ? _b : head;
        return { head, tail };
    }
    renderMapping(component) {
        const componentFactory = this.componentFactoryResolver.resolveComponentFactory(component);
        const componentRef = this.container.createComponent(componentFactory, undefined, this.injector);
        componentRef.instance.component = this.component;
        componentRef.instance.page = this.page.state.getValue();
        return {
            head: componentRef.location.nativeElement,
            tail: componentRef.location.nativeElement,
        };
    }
    ngOnDestroy() {
        var _a;
        (_a = this.clear) === null || _a === void 0 ? void 0 : _a.call(this);
        this.container.clear();
    }
}
BrNodeComponentDirective.decorators = [
    { type: Directive, args: [{
                selector: '[brNodeComponent]',
                inputs: ['component:brNodeComponent'],
            },] }
];
BrNodeComponentDirective.ctorParameters = () => [
    { type: ViewContainerRef },
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: BrNodeDirective },
    { type: BrPageComponent }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnItbm9kZS1jb21wb25lbnQuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9ici1ub2RlLWNvbXBvbmVudC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFFSCxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLFNBQVMsRUFDVCxRQUFRLEVBS1IsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFPOUQsTUFBTSxPQUFPLHdCQUF3QjtJQUtuQyxZQUNVLFNBQTJCLEVBQzNCLFFBQWtCLEVBQ2xCLHdCQUFrRCxFQUNsRCxJQUFxQixFQUNuQixJQUFxQjtRQUp2QixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsU0FBSSxHQUFKLElBQUksQ0FBaUI7UUFDbkIsU0FBSSxHQUFKLElBQUksQ0FBaUI7SUFDOUIsQ0FBQztJQUVKLFdBQVcsQ0FBQyxPQUFzQjs7UUFDaEMsTUFBQSxJQUFJLENBQUMsS0FBSywrQ0FBVixJQUFJLEVBQVc7UUFDZixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXZCLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRXJDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVTLFVBQVU7UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVPLE1BQU07UUFDWixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3RCLE9BQU8sSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQzlCO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxPQUFPLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUM5QjtRQUVELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRU8sY0FBYztRQUNwQix3Q0FBd0M7UUFDeEMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVMsRUFBRTtZQUM3RSxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUc7U0FDbEMsQ0FBQyxDQUFDO1FBQ0gsdUNBQXVDO1FBQ3ZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxlQUFlLENBQUMsU0FBUyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxlQUFlLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRW5ELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVPLGNBQWM7O1FBQ3BCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO2FBQ3ZDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDbEUsU0FBUztZQUNULFNBQVMsRUFBRSxTQUFTO1lBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUc7U0FDbEMsQ0FBQyxDQUFDO2FBQ0YsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRW5DLE1BQU0sSUFBSSxTQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsbUNBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQzlELE1BQU0sSUFBSSxTQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxtQ0FBSSxJQUFJLENBQUM7UUFFN0MsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRU8sYUFBYSxDQUFDLFNBQXdCO1FBQzVDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzFGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFaEcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNqRCxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUV4RCxPQUFPO1lBQ0wsSUFBSSxFQUFFLFlBQVksQ0FBQyxRQUFRLENBQUMsYUFBYTtZQUN6QyxJQUFJLEVBQUUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxhQUFhO1NBQzFDLENBQUM7SUFDSixDQUFDO0lBRUQsV0FBVzs7UUFDVCxNQUFBLElBQUksQ0FBQyxLQUFLLCtDQUFWLElBQUksRUFBVztRQUNmLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDekIsQ0FBQzs7O1lBeEZGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QixNQUFNLEVBQUUsQ0FBRSwyQkFBMkIsQ0FBRTthQUN4Qzs7O1lBVkMsZ0JBQWdCO1lBTGhCLFFBQVE7WUFGUix3QkFBd0I7WUFVakIsZUFBZTtZQUNmLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMjAgSGlwcG8gQi5WLiAoaHR0cDovL3d3dy5vbmVoaXBwby5jb20pXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIERpcmVjdGl2ZSxcbiAgSW5qZWN0b3IsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBUeXBlLFxuICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBvbmVudCwgTWV0YUNvbGxlY3Rpb24gfSBmcm9tICdAYmxvb21yZWFjaC9zcGEtc2RrJztcbmltcG9ydCB7IEJyTm9kZURpcmVjdGl2ZSB9IGZyb20gJy4vYnItbm9kZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgQnJQYWdlQ29tcG9uZW50IH0gZnJvbSAnLi9ici1wYWdlL2JyLXBhZ2UuY29tcG9uZW50JztcbmltcG9ydCB7IEJyUHJvcHMgfSBmcm9tICcuL2JyLXByb3BzLm1vZGVsJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2JyTm9kZUNvbXBvbmVudF0nLFxuICBpbnB1dHM6IFsgJ2NvbXBvbmVudDpick5vZGVDb21wb25lbnQnIF0sIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6IG5vLWlucHV0cy1tZXRhZGF0YS1wcm9wZXJ0eVxufSlcbmV4cG9ydCBjbGFzcyBCck5vZGVDb21wb25lbnREaXJlY3RpdmU8VCBleHRlbmRzIENvbXBvbmVudD4gaW1wbGVtZW50cyBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIGNvbXBvbmVudCE6IFQ7XG5cbiAgcHJpdmF0ZSBjbGVhcj86IFJldHVyblR5cGU8TWV0YUNvbGxlY3Rpb25bJ3JlbmRlciddPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbnRhaW5lcjogVmlld0NvbnRhaW5lclJlZixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgbm9kZTogQnJOb2RlRGlyZWN0aXZlLFxuICAgIHByb3RlY3RlZCBwYWdlOiBCclBhZ2VDb21wb25lbnQsXG4gICkge31cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgdGhpcy5jbGVhcj8uKCk7XG4gICAgdGhpcy5jb250YWluZXIuY2xlYXIoKTtcblxuICAgIGNvbnN0IHsgaGVhZCwgdGFpbCB9ID0gdGhpcy5yZW5kZXIoKTtcblxuICAgIHRoaXMuY2xlYXIgPSBoZWFkICYmIHRhaWwgJiYgdGhpcy5jb21wb25lbnQuZ2V0TWV0YSgpLnJlbmRlcihoZWFkLCB0YWlsKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRNYXBwaW5nKCk6IFR5cGU8QnJQcm9wcz4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnBhZ2UubWFwcGluZ1t0aGlzLmNvbXBvbmVudC5nZXROYW1lKCldO1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXIoKSB7XG4gICAgaWYgKHRoaXMubm9kZS50ZW1wbGF0ZSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGVtcGxhdGUoKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21wb25lbnQgPSB0aGlzLmdldE1hcHBpbmcoKTtcbiAgICBpZiAoIWNvbXBvbmVudCkge1xuICAgICAgcmV0dXJuIHRoaXMucmVuZGVyQ2hpbGRyZW4oKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5yZW5kZXJNYXBwaW5nKGNvbXBvbmVudCk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlclRlbXBsYXRlKCkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICBjb25zdCBlbWJlZGRlZFZpZXdSZWYgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5ub2RlLnRlbXBsYXRlISwge1xuICAgICAgJGltcGxpY2l0OiB0aGlzLmNvbXBvbmVudCxcbiAgICAgIGNvbXBvbmVudDogdGhpcy5jb21wb25lbnQsXG4gICAgICBwYWdlOiB0aGlzLnBhZ2Uuc3RhdGUuZ2V0VmFsdWUoKSEsXG4gICAgfSk7XG4gICAgLy8gdHNsaW50OmVuYWJsZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgY29uc3QgW2hlYWRdID0gZW1iZWRkZWRWaWV3UmVmLnJvb3ROb2RlcztcbiAgICBjb25zdCBbdGFpbF0gPSBlbWJlZGRlZFZpZXdSZWYucm9vdE5vZGVzLnNsaWNlKC0xKTtcblxuICAgIHJldHVybiB7IGhlYWQsIHRhaWwgfTtcbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyQ2hpbGRyZW4oKSB7XG4gICAgY29uc3Qgbm9kZXMgPSB0aGlzLmNvbXBvbmVudC5nZXRDaGlsZHJlbigpXG4gICAgICAubWFwKGNvbXBvbmVudCA9PiB0aGlzLmNvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5wYWdlLm5vZGUsIHtcbiAgICAgICAgY29tcG9uZW50LFxuICAgICAgICAkaW1wbGljaXQ6IGNvbXBvbmVudCxcbiAgICAgICAgcGFnZTogdGhpcy5wYWdlLnN0YXRlLmdldFZhbHVlKCkhLCAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIH0pKVxuICAgICAgLmZsYXRNYXAodmlldyA9PiB2aWV3LnJvb3ROb2Rlcyk7XG5cbiAgICBjb25zdCBoZWFkID0gbm9kZXNbMF0gPz8gdGhpcy5jb250YWluZXIuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgIGNvbnN0IHRhaWwgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXSA/PyBoZWFkO1xuXG4gICAgcmV0dXJuIHsgaGVhZCwgdGFpbCB9O1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJNYXBwaW5nKGNvbXBvbmVudDogVHlwZTxCclByb3BzPikge1xuICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnQpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHRoaXMuY29udGFpbmVyLmNyZWF0ZUNvbXBvbmVudChjb21wb25lbnRGYWN0b3J5LCB1bmRlZmluZWQsIHRoaXMuaW5qZWN0b3IpO1xuXG4gICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50O1xuICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS5wYWdlID0gdGhpcy5wYWdlLnN0YXRlLmdldFZhbHVlKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaGVhZDogY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQsXG4gICAgICB0YWlsOiBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCxcbiAgICB9O1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5jbGVhcj8uKCk7XG4gICAgdGhpcy5jb250YWluZXIuY2xlYXIoKTtcbiAgfVxufVxuIl19